/*!
 * fileLogger
 * Copyright 2016 Peter Bakondy https://github.com/pbakondy
 * See LICENSE in this repository for license information
 */
!function(){angular.module("fileLogger",["ngCordova.plugins.file"]).factory("$fileLogger",["$q","$window","$cordovaFile","$timeout",function(e,r,t,o){"use strict";function n(){return r.parent&&r.parent.ripple}function a(){return!r.cordova&&!r.PhoneGap&&!r.phonegap||n()}function i(){return Date.now()}function c(e){if(e)return e.timestamp=(new Date).toISOString(),y.push({message:JSON.stringify(e)+",\n"}),m?void 0:l()}function l(){if(!y.length)return void(m=!1);m=!0;var e=y.shift();return f(e.message).then(function(){o(function(){return l()})},function(){o(function(){return l()})})}function u(r){return e(function(e,t){r.getMetadata(function(r){e(r.size)},t)})}function f(o){if(a())return r.localStorage[S]||(r.localStorage[S]=""),r.localStorage[S]+=o,e.when();if(!r.cordova||!r.cordova.file||!r.cordova.file.dataDirectory)return e.reject("cordova.file.dataDirectory is not available");var n=t.checkDir(cordova.file.dataDirectory,p)["catch"](function(){return t.createDir(cordova.file.dataDirectory,p)});return n.then(function(){t.checkFile(cordova.file.dataDirectory,p+S).then(function(e){return u(e).then(function(e){return e>w?t.moveFile(cordova.file.dataDirectory,p+S,cordova.file.dataDirectory,p+i()+"_"+S).then(function(){return t.writeFile(cordova.file.dataDirectory,p+S,o,!0)}):t.writeExistingFile(cordova.file.dataDirectory,p+S,o)})})["catch"](function(){return t.writeFile(cordova.file.dataDirectory,p+S,o,!0)})})}function d(){if(a()){var o=0,n=function(){return 0===o},i=function(){return n()?(o++,e.resolve({path:S,content:r.localStorage[S]})):void e.reject("Empty cursor")};return e.when({hasNext:n,next:i})}return r.cordova&&r.cordova.file&&r.cordova.file.dataDirectory?e(function(e,r){t.checkDir(cordova.file.dataDirectory,p).then(function(t){var o=t.createReader();o.readEntries(e,r)},r)}).then(function(r){var o=0,n=function(){return o<r.length},a=function(){var n=r[o];return o++,n.isFile?t.readAsText(cordova.file.dataDirectory,p+n.name).then(function(e){return{path:p+n.name,content:e}}):e.when()};return{hasNext:n,next:a}}):e.reject("cordova.file.dataDirectory is not available")}function v(o){return a()?(r.localStorage.removeItem(o),e.when()):r.cordova&&r.cordova.file&&r.cordova.file.dataDirectory?t.removeFile(cordova.file.dataDirectory,o):e.reject("cordova.file.dataDirectory is not available")}function g(e){return!!(angular.isString(e)&&e.length>0)&&(p=e,!0)}function s(e){return!!(angular.isString(e)&&e.length>0)&&(S=e,!0)}function h(e){return!!(angular.isNumber(e)&&e>0)&&(w=e,!0)}function D(){var o=e.defer();if(a())o.resolve({name:S,localURL:"localStorage://localhost/"+S,type:"text/plain",size:r.localStorage[S]?r.localStorage[S].length:0});else{if(!r.cordova||!r.cordova.file||!r.cordova.file.dataDirectory)return o.reject("cordova.file.dataDirectory is not available"),o.promise;t.checkFile(cordova.file.dataDirectory,S).then(function(e){e.file(o.resolve,o.reject)},o.reject)}return o.promise}var y=[],m=!1,p="logs/",S="messages.log",w=1048576;return{logEvent:c,getLogfiles:d,deleteLogfile:v,setStorageFilename:s,setLogDir:g,setmaxSizeBeforeLogrotate:h,checkFile:D}}])}();